<style>
	.vehicle-enough-points.cf,
	.vehicle-not-enough-points {
		margin-right: -15px;
		margin-top: -3px;
	}

	.vehicle-list.iso-featured {
		display: flex;
		flex-flow: wrap;
	}

	.vehicle-list__item {
		order: 0;
		width: 100%;
	}

	.vehicle-list__item.iso-preSelectedClass .vehicle-item {
		padding-right: 15px;
		margin-right: -15px;
	}

	.iso-tag {
		background: #0A643A;
		color: #fff;
		display: block;
		font-size: 14px;
		padding: 4px 8px 1px 8px;
		width: calc(100% + 15px);
	}

	.iso-unavailable-msg {
		background: #f2f2f2;
		border-bottom: .125rem solid #c3c3c3;
		display: block;
		font-size: 14px;
		padding: 15px 20px;
		width: 100%;
	}

	/* Pre-selected styles */
	.iso-preSelectedClass.iso-preSelectedClass-filtered {
		margin-top: 0;
	}

	.iso-preSelectedClass-filtered .iso-tag {
		display: none;
	}

	.iso-preSelectedClass-filtered .vehicle-item.is-search-by-filter,
	.iso-preSelectedClass-filtered .vehicle-item.is-pre-selected {
		border-color: #169a5a;
	}

	.iso-preSelectedClass {
		margin-top: 7px;
	}

	.iso-tag {
		display: inline;
		font-size: 12px;
		font-weight: 600;
		padding: 4px 15px;
		position: relative;
		width: auto;
	}

	.iso-tag:after {
		border-left: 6px solid transparent;
		border-right: 6px solid transparent;
		border-top: 6px solid #0A643A;
		bottom: -6px;
		content: " ";
		height: 0;
		left: 20px;
		position: absolute;
		width: 0;
	}

	@media (max-width: 1081px) {

		.vehicle-enough-points.cf,
		.vehicle-not-enough-points {
			margin-right: 0;
		}

		.vehicle-list__item.iso-preSelectedClass .vehicle-item {
			padding-right: 0;
			margin-right: 0;
		}

		.iso-tag {
			margin-left: 5px;
			width: 100%;
		}
	}
</style>
<script>
	(function () {
		'use strict';
		var isoTest = {
			debug: false,
			account: 'Enterprise',
			portfolio: 'Enterprise.co.uk',
			test: 'Featured Vehicle 3.0',
			creative: 'Challenger 1',
			filters: '.vehicle-filter__header-cta .vehicle-filter__header-link',
			vehicleItem: '.vehicle-list__item',
			preSelected: '.vehicle-item.is-search-by-filter, .vehicle-item.is-pre-selected',
			template: '<span class="rs-callout rs-callout--highlight"><span class="rs-callout__icon-container"><i role="img" aria-hidden="true" class="rs-callout__icon rs-icon"><svg viewBox="0 0 22 20"><use xlink:href="#icn-star2"></use></svg></i></span><span class="rs-callout__label">{tag}</span></span>',
			featured: {
				0: {
					car: 'IFAR',
					tag: 'Most Versatile',
					shortTag: 'Most Versatile'
				},
				1: {
					car: 'IFAR',
					tag: 'Most Versatile',
					shortTag: 'Most Versatile'
				},
				2: {
					car: 'IFAR',
					tag: 'Most Versatile',
					shortTag: 'Most Versatile'
				},
				3: {
					car: 'IFAR',
					tag: 'Most Versatile',
					shortTag: 'Most Versatile'
				},
				4: {
					car: 'IFAR',
					tag: 'Most Versatile',
					shortTag: 'Most Versatile'
				},
				5: {
					car: 'IFAR',
					tag: 'Most Versatile',
					shortTag: 'Most Versatile'
				},
				6: {
					car: 'IFAR',
					tag: 'Most Versatile',
					shortTag: 'Most Versatile'
				}
			},
			altCar: 'LYMR',
			featAvail: false,
			init: function () {

				isoTest.debug = Boolean(helpers.getQueryParam('debug'));

				isoTest.log('Test Running...');
				isoTest.log(isoTest.account + ' - ' + isoTest.portfolio);
				isoTest.log(isoTest.test + ' - ' + isoTest.creative);

				isoTest.elementLoaded(isoTest.vehicleItem, function () {
					isoTest.log('Test Ready!');
					isoTest.chall();
				});


				window.addEventListener('hashchange', isoTest.hashHandler(), false)
				window.addEventListener('ttFeatVehicle', isoTest.labelVehicle(), false);
				// window.addEventListener('ttFeatOrder', isoTest.labelVehicle, false);

				var spinnerUpdate = new MutationObserver(function (mutationsList) {
					mutationsList.forEach(function (mutation) {
						mutation.removedNodes.forEach(function (removedNode) {
							if (removedNode.classList !== undefined) {
								if (removedNode.classList.contains('spinner-container')) {
									isoTest.elementLoaded(isoTest.vehicleItem, function () {
										isoTest.chall();
										// console.log("is this working?");
									});
								}
							}
						});
					});
				});
				spinnerUpdate.observe(document.querySelector('body'), { subtree: true, childList: true });



			},
			hashHandler: function () {
				// console.log("does this even work");
				if (/cars/.test(location.hash)) {
					isoTest.chall();
					// console.log('testing');

				}
			},
			chall: function () {
				if (window.location.pathname == '/en/reserve.html' && window.location.hash == '#cars') {
					this.waitForEntDatalayer(function () {
						if (!window.store.getState().toJS().app.baobab.model.carSelect.selectedCar) {
							isoTest.runTest();
						}
					});
				}
				// console.log("ping chall")


			},
			runTest: function () {
				// isoTest.elementLoaded(".iso-preSelectedClass .rs-tag-container .rs-tag", function () {
				// 	console.log("got here>>>>>!!!!")

				// });

				// setTimeout(async () => {
				// 	console.log("got here>>>>>!!!!")
				// 	if (document.querySelector(".iso-preSelectedClass .rs-tag-container .rs-tag")) {
				// 		if (document.querySelector(".rs-callout.rs-callout--highlight")) {
				// 			const removeItem = await document.querySelector(".rs-callout.rs-callout--highlight");
				// 			removeItem.remove();
				// 		}
				// 	}
				// }, 5);

				isoTest.observeEl('.rs-callout.rs-callout--highlight', function (el) {
					if (document.querySelector(".iso-preSelectedClass .rs-tag-container .rs-tag")) {
						const removeItem = document.querySelector(".rs-callout.rs-callout--highlight");
						removeItem.style.display = "none"
					}
				})

				isoTest.observeEl('.vehicle-list__item .rs-tag-container', function (el, i) {
					const vehicleRemoved = document.querySelectorAll(".vehicle-list__item .rs-tag-container")
					for (let x = 0; x < vehicleRemoved.length; x++) {
						const getItem = vehicleRemoved[x].parentElement.getAttribute("data-dtm-tracking");
						if (getItem.includes("IFMR")) {
							// console.log("here", x, getItem.includes("IFMR"), vehicleRemoved[x])
							vehicleRemoved[x].parentElement.style.display = "none";
						}
					}
				})

				// console.log(document.querySelector(".iso-preSelectedClass .rs-tag-container .rs-tag"));
				// console.log('runTest()');
				// isoTest.day = helpers.getQueryParam('dayOverride') ? helpers.getQueryParam('dayOverride') : new Date(ReservationStateTree.get(['session', 'reservationSession','pickup_time'])).getDay();

				// this matches up the index of the day to the json object
				isoTest.day = new Date(store.getState().toJS().app.baobab.session.reservationSession.pickup_time).getDay();
				isoTest.vehicleClass = isoTest.featured[isoTest.day];
				// console.log("This is the vehicle class", isoTest.vehicleClass, isoTest.day);
				isoTest.onLoadpreSelected = document.querySelectorAll(isoTest.preSelected).length > 0;
				isoTest.checkSort();

				// Filters and sort
				// var filterElements = document.querySelectorAll('.vehicle-filter__filter .form-checkbox,.vehicle-filter__header-link, .vehicle-redemption__options-cta, .iso-pay');
				var filterElements = document.querySelectorAll('.vehicle-filter__filter, .vehicle-redemption__options-cta, .iso-pay');
				for (var i = 0; i < filterElements.length; i++) {
					filterElements[i].addEventListener('click', function () {
						console.log('Event: Filter Checkbox Click');
						setTimeout(isoTest.checkSort, 200);
					}, false);
				}

				document.addEventListener('click', function (e) {
					if (e.target.matches('[data-dtm-tracking^="cars|filter_modal|submit"]') || e.target.matches('[data-dtm-tracking^="car_filters|clear_filters|select"]')) {
						if (!store.getState().toJS().app.baobab.model.carSelect.selectedCar) {
							isoTest.checkSort();
						}
					}
				});
				document.querySelector('#vehicleSortBy').addEventListener('change', function () {
					setTimeout(isoTest.checkSort, 200);
				}, false);


				// console.log("ping runtest")
			},
			checkSort: function () {
				isoTest.elementLoaded(isoTest.vehicleItem, function () {
					var sort = document.querySelector('#vehicleSortBy').value;
					var list = document.querySelector('.vehicle-list');
					if (sort == 'Recommended') {
						list.classList.add('iso-featured');
					} else {
						list.classList.remove('iso-featured');
					}
					isoTest.labelVehicle();
				});
			},
			labelVehicle: function () {
				// console.log('labelVehicle()', store.getState().toJS().app.baobab.session.reservationSession.pickup_time);
				isoTest.vehicleItems = document.querySelectorAll('.vehicle-list > li');
				isoTest.lastPreselectedIndex = document.querySelectorAll(isoTest.preSelected).length - 1;
				isoTest.lastPreselected = document.querySelectorAll(isoTest.preSelected)[isoTest.lastPreselectedIndex];
				if (isoTest.lastPreselected) {
					var vehicleItems = Array.prototype.slice.call(isoTest.vehicleItems);
					isoTest.lastPreselectedIndex = vehicleItems.indexOf(isoTest.lastPreselected.parentNode);
				}

				isoTest.elementLoaded(isoTest.vehicleItem, function () {
					isoTest.day = new Date(store && store.getState().toJS().app.baobab.session.reservationSession.pickup_time).getDay();
					isoTest.vehicleClass = isoTest.featured[isoTest.day];
					isoTest.findVehicle(isoTest.vehicleClass.car);
					if (document.querySelectorAll('.iso-preSelectedClass').length == 0 && isoTest.altCar && !isoTest.featAvail) {
						isoTest.findVehicle(isoTest.altCar);
					}
					isoTest.reOrder();
				});

				// console.log("ping labelvehicle")
			},
			findVehicle: function (featClass) {
				for (var i = 0; i < isoTest.vehicleItems.length; i++) {
					if (!isoTest.vehicleItems[i].classList.contains('iso-preSelectedClass') && isoTest.vehicleItems[i].classList.contains('vehicle-list__item')) {
						var dataInfo = isoTest.vehicleItems[i].getAttribute('data-dtm-tracking').split('|');
						var carClass = dataInfo[1];
						var avail = dataInfo[2];
						console.log(carClass + ' :: ' + avail);
						if (carClass == featClass && (avail != 'SOLD_OUT' && avail != 'RESTRICTED_AT_RETAIL_RATE')) {
							isoTest.addPreselect(isoTest.vehicleItems[i]);
							isoTest.featAvail = carClass == isoTest.altCar ? false : true;
						}
					}
				}
				// console.log("ping findvehicle")
			},
			addPreselect: function (vehicleItem) {
				vehicleItem.classList.add('iso-preSelectedClass');
				var vi = vehicleItem.querySelector('.vehicle-item');
				if (isoTest.onLoadpreSelected && (vi.classList.contains('is-search-by-filter') || vi.classList.contains('is-pre-selected'))) {
					vehicleItem.classList.add('iso-preSelectedClass-filtered');
				} else if (isoTest.onLoadpreSelected && (!vi.classList.contains('is-search-by-filter') || !vi.classList.contains('is-pre-selected'))) {
					vehicleItem.classList.add('iso-preselected-second');
				}

				var tag = helpers.supplant(isoTest.template, {
					'tag': isoTest.onLoadpreSelected ? isoTest.vehicleClass.shortTag : isoTest.vehicleClass.tag
				});
				vehicleItem.insertAdjacentHTML('afterbegin', tag);
				// console.log("ping addpreselect")
			},
			waitForEntDatalayer: function (callback) {
				var maxCheck = 500;
				var interval = window.setInterval(function () {
					if (
						window.store &&
						window.store.getState() &&
						window.store.getState().toJS() &&
						window.store.getState().toJS().app &&
						window.store.getState().toJS().app.baobab &&
						window.store.getState().toJS().app.baobab.session &&
						window.store.getState().toJS().app.baobab.session.reservationSession &&
						window.store.getState().toJS().app.baobab.session.reservationSession.pickup_time
					) {
						callback();
						window.clearInterval(interval);
					} else if (--maxCheck < 0) {
						window.clearInterval(interval);
					}
				}, 50);
			},
			reOrder: function () {
				var o = 0;
				var featVehicle = document.querySelector('.iso-preSelectedClass .vehicle-item');
				if (featVehicle && (!featVehicle.classList.contains('is-search-by-filter') || !featVehicle.classList.contains('is-pre-selected'))) {
					for (var i = 0; i < isoTest.vehicleItems.length; i++) {
						if (!isoTest.vehicleItems[i].classList.contains('iso-preSelectedClass')) {
							isoTest.vehicleItems[i].style.order = o;
							if (i == 0 && isoTest.lastPreselectedIndex == -1 && (isoTest.vehicleItems[i].classList.contains('vehicle-list__unavailable-car') || isoTest.vehicleItems[i].firstChild.classList.contains('vehicle-not-enough-points'))) {
								o += 1;
								featVehicle.parentNode.style.order = o;
							} else if (i == 0 && isoTest.lastPreselectedIndex == -1 && !isoTest.vehicleItems[i].firstChild.classList.contains('vehicle-not-enough-points')) {
								featVehicle.parentNode.style.order = -1;
							} else if (i == isoTest.lastPreselectedIndex) {
								o += 1;
								featVehicle.parentNode.style.order = o;
							}
							o++;
						} else {
							if (i == 0 && isoTest.vehicleItems[i].classList.contains('iso-preSelectedClass')) {
								featVehicle.parentNode.style.order = o;
								o++;
							}
						}
					}
				}
				var e = new Event('ttFeatOrder');
				window.dispatchEvent(e);
				// console.log("ping reorderfunc")
			},
			observeEl: function (selector, callback) {
				var processed = new Map();

				var processElement = function processElement(el) {
					if (processed && !processed.has(el)) {
						processed.set(el, true);
						callback(el);
					}
				};

				var lookForSelector = function lookForSelector() {
					var el = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : document;

					if (el.matches && el.matches(selector)) {
						if (processElement(el)) return true;
					}

					if (el.querySelectorAll) {
						var elements = el.querySelectorAll(selector);

						if (elements.length) {
							for (var i = 0; i < elements.length; i++) {
								var _el = elements[i];
								if (processElement(_el)) return true;
							}
						}
					}
				};
				lookForSelector();

				var obs = new MutationObserver(function (mutationsList) {
					mutationsList.forEach(function (record) {
						if (record && record.addedNodes && record.addedNodes.length) {
							for (var i = 0; i < record.addedNodes.length; i++) {
								var el = record.addedNodes[i].parentElement;
								if (el && lookForSelector(el)) return true;
							}
						}
					});
				});
				obs.observe(document, {
					attributes: true,
					attributeFilter: ['style', 'className'],
					childList: true,
					subtree: true
				});
			},
			elementLoaded: function (ele, callback) {
				isoTest.log('elementLoaded::  ' + ele + ' - Checking...');
				window.clearTimeout(isoTest.eleTimer);
				if (document.querySelectorAll(ele).length > 0) {
					if (typeof callback === 'function') {
						isoTest.log('elementLoaded::  ' + ele + ' - Found!');
						callback();
					}
				} else {
					isoTest.eleTimer = window.setTimeout(function () { isoTest.elementLoaded(ele, callback); }, 100);
				}
			},
			log: function (obj) {
				if (isoTest.debug === true) {
					console.log(obj);
				}
			}
		};
		var helpers = {
			getQueryParam: function (variable) {
				var query = window.location.search.substring(1);
				var vars = query.split('&');
				for (var i = 0; i < vars.length; i++) {
					var pair = vars[i].split('=');
					if (decodeURIComponent(pair[0]) == variable) {
						return decodeURIComponent(pair[1]);
					}
				}
			},
			supplant: function (str, o) {
				return str.replace(/{([^{}]*)}/g, function (a, b) {
					var p = b.split(/\./),
						c = o;
					for (var i = 0; i < p.length; i++) {
						if (c[p[i]] == null)
							return a;
						c = c[p[i]];
					}
					return typeof c === 'string' || typeof c === 'number' ? c : a;
				});
			}
		};
		isoTest.init();
	})();
</script>