<style>
	.vehicle-select__controls:not(.update){
		display: none;
	}
	#updatedFiltersDrawer{
		max-height: 0;
	}
	#updatedFiltersDrawer.filters-drawer--open{
		max-height: none;
    overflow: visible;
	}
	.filters-drawer__count__btn-reset.hide{
		display: none;
	}
	.vehicle-list.filtered .vehicle{
		display: none;
	}
	.vehicle-list.filtered .vehicle[data-filter-applied="true"]{
		display: block;
	}
	.vehicle-list > div[data-filter-applied="true"]{
    border-top: 0.125rem solid rgba(35,31,32,.2);
	}
	.vehicle-list > div[data-filter-applied="true"] ~ div{
    border-top: 0;
	}
</style>
<script>
(function() {
	'use strict';
	var isoTest = {
		account : 'EHI',
		portfolio : 'National',
		test : 'MVT-470',
		creative : 'Challenger 2',
		selector : '.vehicle-list > .vehicle',
		allCarsObj : {},
		filtersApplied : {},
		getReactComponent : function(node){
			for(var key in node) {
				if(key.startsWith('__reactInternalInstance$') ) {
					return node[key];
				}
			}
			return null;
		},
		observeEl : function(selector, callback) {
			var processed = new Map();

			var processElement = function processElement(el) {
				if (processed && !processed.has(el)) {
					processed.set(el, true);
					callback(el);
				}
			};

			var lookForSelector = function lookForSelector() {
				var el = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : document;

				if (el.matches && el.matches(selector)) {
					if (processElement(el)) return true;
				}

				if (el.querySelectorAll) {
					var elements = el.querySelectorAll(selector);

					if (elements.length) {
						for (var i = 0; i < elements.length; i++) {
							var _el = elements[i];
							if (processElement(_el)) return true;
						}
					}
				}
			};
			lookForSelector();

			var obs = new MutationObserver(function (mutationsList) {
				mutationsList.forEach(function (record) {
					if (record && record.addedNodes && record.addedNodes.length) {
						for (var i = 0; i < record.addedNodes.length; i++) {
							var el = record.addedNodes[i].parentElement;
							if (el && lookForSelector(el)) return true;
						}
					}
				});
			});
			obs.observe(document, {
				attributes: false,
				childList: true,
				subtree: true
			});
		},
		updateCarsObject : function(){
			isoTest.observeEl('.vehicle-list', function(vehicleList){
				// console.log('Updating cars object');

				// List of all vehicles
				var allCars = isoTest.getReactComponent(vehicleList).return.memoizedProps.vehicles.all;

				// Loop through the allCars array and assign the "code" as the object key
				allCars.forEach(function(car) {
					isoTest.allCarsObj[car.code] = car;
				});

				// console.log(isoTest.allCarsObj);

				// Add the filter container alongside the vehicle list
				isoTest.addFilterContainer(vehicleList);

				setTimeout(function(){
					isoTest.updateFilterContainer();
				}, 0);
			});
		},
		observeEachCar : function(){
			// We'll want to make sure we've gotten the data we need before we start
			isoTest.observeEl('.vehicle-list > .vehicle', function(vehicleEl){
				var vehicleReact = isoTest.getReactComponent(vehicleEl);
				var sippCode = vehicleReact.return.memoizedProps.vehicleCode;
				var vehicleInfo = isoTest.allCarsObj[sippCode];

				vehicleEl.setAttribute('data-capacity', vehicleInfo.people_capacity);
				vehicleEl.setAttribute('data-category', vehicleInfo.category.name);
				vehicleEl.setAttribute('data-sipp', vehicleInfo.code);
				vehicleEl.setAttribute('data-unlimited', vehicleInfo.mileage_info.unlimited_mileage);
			});
		},
		updateVehicleResults : function(filtersShown){
			var inputs = document.querySelectorAll('#updatedFiltersDrawer input:checked');
			var filterContainer = document.querySelector('.vehicle-select__controls.update');
			var filterResults = filterContainer.querySelector('.filters-drawer__results');
			var allVehicles = document.querySelectorAll('.vehicle-list .vehicle');

			// Remove the filtered attribute we added to the vehicles
			allVehicles.forEach(function(vehicle){
				vehicle.removeAttribute('data-filtered');
			});

			// Get the filters that are currently applied
			var filters = [];
			for(var i = 0; i < inputs.length; i++){
				var input = inputs[i];
				var name = input.getAttribute('data-name');
				var category = input.getAttribute('data-category');

				// console.log(filtersShown[category][name]);
				filters.push(...filtersShown[category][name]);
			}
			
			// For the list of vehicles in the filters vehicle list, set the "data-filtered" attribute to true
			for(var i = 0; i < filters.length; i++){
				var vehicle = filters[i];
				vehicle.setAttribute('data-filtered', true);
			}

			// Update the number of filter results
			var filteredVehicles = document.querySelectorAll('.vehicle-list .vehicle[data-filtered="true"]');
			var clearResults = document.querySelector('.filters-drawer__count__btn-reset');
			var clearBtn = document.querySelector('#updatedFiltersDrawer .cancel-and-apply-buttons .btn--underline');
			var applyBtn = document.querySelector('#updatedFiltersDrawer .cancel-and-apply-buttons [type="submit"]');

			if(filteredVehicles.length > 0){
				filterResults.innerHTML = filteredVehicles.length + ' Results';
				clearResults.classList.remove('hide');
				clearBtn.disabled = false;
				// applyBtn.disabled = false;
			} else {
				filterResults.innerHTML = '';
				clearResults.classList.add('hide');

				if(!document.querySelector('.vehicle-list.filtered')){
					clearBtn.disabled = true;
					// applyBtn.disabled = true;
				}
			}
		},
		changedFilter : function(clearFilters){
			// For each item in the filtersApplied object, check to see if it's still checked
			var change = false;
			for(var inputId in isoTest.filtersApplied){
				var filterApplied = isoTest.filtersApplied[inputId];
				if(filterApplied && (filterApplied.applied === false || filterApplied.changed === true)){
					// console.log('A change has been made to the filter', inputId);
					change = true;
				}
			}

			var applyButton = document.querySelector('#updatedFiltersDrawer .cancel-and-apply-buttons [type="submit"]');
			if(change){
				// console.log('Apply button should be active');
				applyButton.removeAttribute('disabled');
			}else{
				// console.log('Apply button should be disabled');
				applyButton.setAttribute('disabled', true);
			}
		},
		checkFilters : function(){

			// Uncheck filters that were not applied
			var checkedInputs = document.querySelectorAll('#updatedFiltersDrawer input:checked');
			checkedInputs.forEach(function(input){
				if(isoTest.filtersApplied[input.id] && isoTest.filtersApplied[input.id].changed === true){
					// console.log('Removing filter: ' + input.id);
					input.click();
				}
			});
			
			// Re-check filters that were changed but not applied
			for(var inputId in isoTest.filtersApplied){
				var input = document.getElementById(inputId);
				if(input){
					if(!input.checked && isoTest.filtersApplied[input.id].applied !== undefined){
						// console.log('Adding filter: ' + input.id);
						input.click();
					}
				}
			}
		},
		clearFilters : function(collapseFilters){
			var checkedInputs = document.querySelectorAll('#updatedFiltersDrawer input:checked');
			for(var i = 0; i < checkedInputs.length; i++){
				checkedInputs[i].click();
			}
			if(collapseFilters){

				// Reset the filters applied object
				isoTest.filtersApplied = {};
				// On clear, make sure the apply button is disabled
				isoTest.changedFilter();
				
				var filtersButton = document.querySelector('.drawer-animation--open .js-filters-button');
				if(filtersButton){
					filtersButton.click();
				}

				// Remove the filters from the vehicle list
				var allFilteredVehicles = document.querySelectorAll('.vehicle-list .vehicle[data-filter-applied="true"]');
				allFilteredVehicles.forEach(function(vehicle){
					vehicle.removeAttribute('data-filter-applied');
				});

				var filterList = document.querySelector('.vehicle-list');
				filterList.classList.remove('filtered');
			}
		},
		applyFilters : function(){
			// Check to make sure filters are actually applied
			var checkedInputs = document.querySelectorAll('#updatedFiltersDrawer input:checked');
	
			var filterList = document.querySelector('.vehicle-list');

			// Rest the filters applied object
			isoTest.filtersApplied = {};
			isoTest.changedFilter();

			if(checkedInputs.length > 0){

				// Pull the ids from all the checked inputs
				checkedInputs.forEach(function(input){
					isoTest.filtersApplied[input.id] = {
						applied: true
					}
				});

				// Add "filtered" class to hide vehicles that don't match
				filterList.classList.add('filtered');

				// Reset the existing filter results
				var currentlyFilteredVehicles = document.querySelectorAll('.vehicle-list .vehicle[data-filter-applied="true"]');
				currentlyFilteredVehicles.forEach(function(vehicle){
					vehicle.removeAttribute('data-filter-applied');
				});

				// Apply filtered attribute to set of filtered vehicles
				var allFilteredVehicles = document.querySelectorAll('.vehicle-list .vehicle[data-filtered="true"]');
				allFilteredVehicles.forEach(function(vehicle){
					vehicle.setAttribute('data-filter-applied', true);
				});
			}else{
				var clearBtn = document.querySelector('#updatedFiltersDrawer .cancel-and-apply-buttons .btn--underline');
				var applyBtn = document.querySelector('#updatedFiltersDrawer .cancel-and-apply-buttons [type="submit"]');
				filterList.classList.remove('filtered');

				clearBtn.disabled = true;
				applyBtn.disabled = true;
			}

			// Collapse filter container
			var filtersButton = document.querySelector('.js-filters-button');
			filtersButton.click();
		},
		addFilterEvents : function(filtersShown){
			var filterContainer = document.querySelector('.vehicle-select__controls.update');
			var filtersButton = filterContainer.querySelector('.js-filters-button span');
			var inputs = document.querySelectorAll('#updatedFiltersDrawer input');
			var numOfFilters = 0;

			for(var i = 0; i < inputs.length; i++){
				var input = inputs[i];

				input.addEventListener('change', function(e){
					var name = e.target.getAttribute('data-name');
					var category = e.target.getAttribute('data-category');
					var filteredVehicles = filtersShown[category][name];
					var filterIsChecked = e.target.checked;

					// Update the filter count
					if(filterIsChecked){
						numOfFilters++;
					} else {
						numOfFilters--;
					}

					// Set a true or false value for existing filtersApplied object items depending on the filterIsChecked value
					var filterApplied = isoTest.filtersApplied[e.target.id];
					if(filterApplied && filterApplied.applied !== undefined){
						// Existing filter - if it's unchecked we want this value to be false
						isoTest.filtersApplied[e.target.id].applied = filterIsChecked;
					}else{
						// New filter - if it's checked we want this value to be true
						isoTest.filtersApplied[e.target.id] = {
							changed: filterIsChecked
						}
					}

					// Check filters here if we want to disable the submit button if there are no filter changes
					isoTest.changedFilter();
					// console.log('Current filters applied object: ', isoTest.filtersApplied);

					// Update our results
					if(numOfFilters > 0){
						filtersButton.innerHTML = ' (' + numOfFilters + ')';
					} else {
						filtersButton.innerHTML = '';
					}

					isoTest.updateVehicleResults(filtersShown);
				});
			}

			// Clear button events
			var clearResults = document.querySelector('.filters-drawer__count__btn-reset');
			clearResults.addEventListener('click', () => {
				isoTest.clearFilters(true);
			});
			var clearLink = document.querySelector('#updatedFiltersDrawer .cancel-and-apply-buttons .btn--underline');
			clearLink.addEventListener('click', () => {
				isoTest.clearFilters(false);
			});

			var applyBtn = document.querySelector('#updatedFiltersDrawer .cancel-and-apply-buttons [type="submit"]');
			applyBtn.addEventListener('click', (e) => {
				e.preventDefault();

				isoTest.applyFilters();
			});
		},
		addFilterCategories : function(filtersShown, filterDrawer){

			var allFiltersHTML = '';

			// Loop through the filtersShown category, seats, and mileage objects and add in the filter category if there's more than one filter
			var filterCategories = Object.keys(filtersShown);
		
			for (var i = 0; i < filterCategories.length; i++) {
				var category = filterCategories[i];
				var filters = filtersShown[category];

				allFiltersHTML += `
					<fieldset>
						<legend class="section-title">${category}</legend>
						<div class="filters-drawer__checkboxes">
				`;

				// console.log(filters);
				var filterCheckboxes = Object.keys(filters);
				for (var j = 0; j < filterCheckboxes.length; j++) {
					var filter = filterCheckboxes[j];

					// Only add in the filter if there's a car that matches it
					if(filters[filter].length > 0){
						allFiltersHTML += `
								<div class="input-option-container-wrapper">
									<div class="input-option-container">
										<input id="vehicle_select_${category}_${filter}" type="checkbox" name="${category}" data-name="${filter}" data-category="${category}" data-dtm-track="checkbox.vehicle_select_${category}_${filter}.unchecked" /><label for="vehicle_select_${category}_${filter}">${filter}</label>
									</div>
								</div>
						`;
					}
				}

				allFiltersHTML += `
						</div>
					</fieldset>
				`;
			}

			filterDrawer.insertAdjacentHTML('beforeend', allFiltersHTML);
			isoTest.addFilterEvents(filtersShown);
		},
		updateFilterContainer : function(){
			var filterContainer = document.querySelector('.vehicle-select__controls.update');
			var filterDrawer = filterContainer.querySelector('.filters-drawer__form .clearfix');
			var filterResults = filterContainer.querySelector('.filters-drawer__results');

			var allCars = document.querySelectorAll('.vehicle-list > .vehicle');
			var filtersShown = {
				category: {
					'Cars': [],
					'Trucks': [],
					'SUVs': [],
					'Vans': [],
				},
				mileage: {
					'Unlimited Mileage': [],
					'Limited Mileage': [],
				},
				seats: {
					'2+': [],
					'4+': [],
					'5+': [],
					'7+': [],
				}
			};

			// Loop through cars and update our filters list
			allCars.forEach(function(car){
				var category = car.getAttribute('data-category');
				var seats = car.getAttribute('data-capacity');
				var mileage = car.getAttribute('data-unlimited');

				if(filtersShown.category[category]){
					filtersShown.category[category].push(car);
				}

				if(seats > 2){
					filtersShown.seats['2+'].push(car);
				}
				if(seats > 4){
					filtersShown.seats['4+'].push(car);
				}
				if(seats > 5){
					filtersShown.seats['5+'].push(car);
				}
				if(seats > 7){
					filtersShown.seats['7+'].push(car);
				}

				if(mileage === 'true'){
					filtersShown.mileage['Unlimited Mileage'].push(car);
				}else{
					filtersShown.mileage['Limited Mileage'].push(car);
				}
			});

			filterResults.innerHTML = allCars.length + ' Results';

			isoTest.addFilterCategories(filtersShown, filterDrawer);
		},
		addFilterContainer : function(){
			var filterContainer = `
				<div class="vehicle-select__controls update">
					<div class="filters-drawer input-option--larger-on-large input-option--larger-on-medium" role="presentation">
						<div class="filters-drawer__count"><button aria-controls="filtersDrawer" aria-expanded="false" class="btn-link btn-toggle js-filters-button">Filters<span class="btn-link__text"></span></button><span class="filters-drawer__results">0 Results</span><button class="filters-drawer__count__btn-reset hide"><span class="icon--circleclose"></span><span class="filters-drawer__count__btn-reset-text">Reset Filters</span></button></div>
						<div id="updatedFiltersDrawer" class="filters-drawer__form-wrap drawer-animation__content" aria-hidden="true">
							<form class="filters-drawer__form">
								<div class="clearfix"></div>
								<fieldset class="filters-drawer__buttons cancel-and-apply-buttons cancel-and-apply-buttons--3-and-2-of-12">
									<button type="submit" disabled="" class="btn">Apply</button><button type="button" disabled="" class="btn btn--opaque btn--underline">clear</button>
								</fieldset>
							</form>
						</div>
					</div>
				</div>
			`;
			
			var existingFilter = document.querySelectorAll('.vehicle-select__controls');
			if(existingFilter.length === 1){
				existingFilter[0].insertAdjacentHTML('afterend', filterContainer);

				var filterContainer = document.querySelector('.vehicle-select__controls.update');
				var filterButton = filterContainer.querySelector('.filters-drawer__count button');

				// Opens and closes the filter drawer
				filterButton.addEventListener('click', function(){
					var filterDrawer = document.querySelector('#updatedFiltersDrawer');
					filterDrawer.classList.toggle('filters-drawer--open');
					filterContainer.querySelector('.filters-drawer').classList.toggle('drawer-animation--open');

					isoTest.checkFilters();
				});
			}
		},
		init : function() {
			if (_satellite && typeof _satellite.setVar === 'function' && typeof _satellite.track === 'function') {
				_satellite.setVar('TargetCampaign', isoTest.test);
				_satellite.setVar('TargetCreative', isoTest.creative);
			}

			isoTest.log('Test Running...');
			isoTest.log(isoTest.account + ' - ' + isoTest.portfolio);
			isoTest.log(isoTest.test + ' - ' + isoTest.creative);

			helpers.elementLoaded(isoTest.selector, function() {
				isoTest.log('Test Ready!');
  			isoTest.chall();
			});
		},
		chall : function() {
			isoTest.updateCarsObject();
			isoTest.observeEachCar();
		},
		fireTag : function(element, value) {
			var linkName = value ? value : element.innerText;
				linkName = isoTest.test ? isoTest.test + ' : ' + linkName : linkName;
			s.linkTrackVars = 'eVar20';
			s.eVar20 = linkName;
			s.tl(this, 'o', linkName);
		},
		log : function(obj){
			if(isoTest.debug === true){
				console.log(obj);
			}
		}
	};

	var helpers = {
		elementLoaded : function (ele, callback) {
			isoTest.log('elementLoaded::  ' + ele + ' - Checking...');
			window.clearTimeout(isoTest.eleTimer);
			if (document.querySelectorAll(ele).length > 0) {
				if (typeof callback === 'function') {
					isoTest.log('elementLoaded::  ' + ele + ' - Found!');
					callback();
				}
	    } else {
				isoTest.eleTimer = window.setTimeout(function(){helpers.elementLoaded(ele, callback);}, 100);
			}
		}
	};

	isoTest.init();
})();
</script>
