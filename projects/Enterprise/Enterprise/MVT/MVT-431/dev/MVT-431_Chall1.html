<style>
</style>
<script>
	(function () {
		'use strict';

		var isoTest = {
			account: 'EHI',
			portfolio: 'Enterprise',
			test: 'MVT-431',
			creative: 'Challenger 1',
			selector: '.location-header__toggle-buttons [aria-label*="Filter"]',
      filtersApplied: {
        anyApplied: false,
        openSundays: false,
        afterHoursPickup: false,
        afterHoursReturn: false
      },
			init: function () {

				var open_prototype = window.XMLHttpRequest.prototype.open;
        window.XMLHttpRequest.prototype.open = function() {
          this.addEventListener('readystatechange', function(event) {
              var matchPageHash = window.location.hash === '#location';
              var matchRequest = this.responseURL.indexOf('prd.location.enterprise.com/enterprise-sls/search/location/enterprise/web/spatial') > -1;
              var matchParams = this.responseURL.indexOf('&pickupDate') > -1;
              
              if ( this.readyState === 4 && matchRequest && matchParams && matchPageHash ) {

                var response = event.target.responseText;
                Object.defineProperty(this, 'response',     {writable: true});
                Object.defineProperty(this, 'responseText', {writable: true});

                var initialRequest = JSON.parse(response);
                if(initialRequest.result && initialRequest.result.length > 0) {

                  initialRequest.result = isoTest.filterRequest(initialRequest.result);

                  response =  JSON.stringify(initialRequest);
                }

                this.response = this.responseText = response;
              }
          });
          return open_prototype.apply(this, arguments);
        };

				if (_satellite && typeof _satellite.setVar === 'function' && typeof _satellite.track === 'function') {
					_satellite.setVar('TargetCampaign', isoTest.test);
					_satellite.setVar('TargetCreative', isoTest.creative);
				}

				isoTest.log('Test Running...');
				isoTest.log(isoTest.account + ' - ' + isoTest.portfolio);
				isoTest.log(isoTest.test + ' - ' + isoTest.creative);

				helpers.elementLoaded(isoTest.selector, function () {
					isoTest.log('Test Ready!');
					isoTest.chall();
				});

			},
      triggerUpdate : function(){
        var getReactComponent = function(node){
          for(var key in node) {
            if(key.startsWith('__reactInternalInstance$') ) {
              return node[key];
            }
          }
          return null;
        }
        
        getReactComponent(document.querySelector('.map-wrapper')).return.memoizedProps.onSearchThisArea();
      },
      clearFilters : function() {
        isoTest.filtersApplied = {
          anyApplied: false,
          openSundays: false,
          afterHoursPickup: false,
          afterHoursReturn: false
        };
        isoTest.triggerUpdate();
      },
      applyFilter : function(filter) {
        isoTest.filtersApplied[filter] = !isoTest.filtersApplied[filter];

        // If we have any filters applied, then we need to show the adjusted results
        isoTest.filtersApplied.anyApplied = false;
        for(var key in isoTest.filtersApplied) {
          if(!!isoTest.filtersApplied[key]){
            isoTest.filtersApplied.anyApplied = true;
          }
        }
				console.log(isoTest.filtersApplied);
        isoTest.triggerUpdate();
      },
      getFilterMatches : function(results){
        var resultsObj = {
          openSundays: [],
          afterHoursPickup: [],
          afterHoursReturn: []
        }

        results.forEach(function(result){
          if(result.additional_data.open_sundays){
            resultsObj.openSundays.push(result)
          }
          if(result.after_hours_pickup){
            resultsObj.afterHoursPickup.push(result)
          }
          if(result.after_hours_return){
            resultsObj.afterHoursReturn.push(result)
          }
        });

        return resultsObj;
      },
      filterRequest : function(results){
        if(isoTest.filtersApplied.anyApplied) {
          var resultsObj = isoTest.getFilterMatches(results);

          var filteredItems = false;
          for(var key in isoTest.filtersApplied) {
            if(isoTest.filtersApplied[key]){
              if(!!filteredItems){
                filteredItems = filteredItems.filter(element => resultsObj[key].includes(element));
              }else{
                filteredItems = resultsObj[key];
              }
            }
          }

          console.log(filteredItems);
          return filteredItems;
        }else{
          return results;
        }
      },
			chall: function () {
        var filterFired = false;
        var filterButton = document.querySelector('.location-header__toggle-buttons [aria-label*="Filter"]');
        filterButton.addEventListener('click', function(e) {
          if(!filterFired) {
            console.log('Filter button clicked!');
            filterFired = true;
            isoTest.creation();
          }
        });
			},
			//Creation of our items
			creation: function () {
				var codeRan = document.querySelector(".iso");
				if (!codeRan) {
					//We first find our elemnts
					var locationTypeContainer = document.querySelector(".location-search-filter__container-modal-filters-block");
					var locationCheckboxContainer = document.querySelector(".location-search-filter__container-check-filters-block");
					var locationType = document.querySelector(".filter-modal-button.locations-filter-trigger.location-search-filter__locations-filter.location-search-filter__filter-input");
					var locationTypeCarrot = locationType.querySelector(".icon.icon-nav-carrot-down");
					var locationCheckbox = document.querySelector(".form-checkbox.location-search-filter__container-filter");
					//Everything is cloned below
					var modalBtn = locationType.cloneNode(true);
					var checkbox = locationCheckbox.cloneNode(true);
					var modalBtnLabelTxt = modalBtn.querySelector(".filter-modal-button__label-text");
					var modalBtnTxt = modalBtn.querySelector(".btn.filter-modal-button__button.btn-input");
					var checkboxTxt = checkbox.querySelector(".form-checkbox__text");
					var carrot = locationTypeCarrot.cloneNode(true);
					//Cloned elemnets are adjusted below (copy ect)
					modalBtnLabelTxt.innerText = 'Services';
					modalBtnTxt.innerText = 'All Services';
					checkboxTxt.innerText = 'Open Sundays';
					modalBtn.classList.add("iso");
					checkbox.classList.add("iso");
          checkbox.classList.add('js-sunday');
					locationTypeContainer.insertAdjacentElement("beforeend", modalBtn);
					locationCheckboxContainer.insertAdjacentElement("beforeend", checkbox);
					modalBtn.querySelector(".btn.filter-modal-button__button.btn-input").insertAdjacentElement("beforeend", carrot);


          var openSundays = document.querySelector('.js-sunday input');
          openSundays.addEventListener('change', function(e) {
            console.log('Open sundays clicked now!!');
            isoTest.applyFilter('openSundays');
          });

					modalBtnTxt.addEventListener('click', function (event) {
						isoTest.modalFunctionality()
					});
					// <button class="btn locations-filter-modal-content__clear-all btn-unstyled btn--outline btn--underline" type="button">Clear All</button>
				}
			},
			modalFunctionality: function () {
				document.querySelector('.ReactModalPortal').insertAdjacentHTML("beforeend", `
					<div class="ReactModal__Overlay ReactModal__Overlay--after-open modal-overlay">
						<div class="ReactModal__Content ReactModal__Content--after-open default-modal" tabindex="-1" role="dialog" aria-labelledby="modal-heading" aria-modal="true" aria-describedby="modal-content">
							<div class="modal-inner">
								<div class="modal-header">
									<button class="close-modal" aria-label="Close" type="button"><i class="icon icon-close-x-white" aria-hidden="true">X</i></button>
								</div>
								<div class="modal-content cf">
									<div class="locations-filter-modal-content">
										<h2 id="modal-heading" class="modal-content__heading">Service</h2>
										<div class="locations-filter-modal-content__filters" id="modal-content">
											<p>Select the service you want to search by.</p>
											<label class="form-checkbox locations-filter-modal-content__checkbox">
												<input type="checkbox" name="afterHoursReturn" id="afterHoursReturn" class="form-checkbox__input is-vishidden" value="" /><span class="form-checkbox__control"><i class="icon icon-check-green"></i></span>
												<span class="form-checkbox__text"><span class="locations-filter-modal-content__checkbox-text">Pick-Up Service Available </span></span>
											</label>
											<label class="form-checkbox locations-filter-modal-content__checkbox">
												<input type="checkbox" name="afterHoursPickup" id="afterHoursPickup" class="form-checkbox__input is-vishidden" value="" /><span class="form-checkbox__control"><i class="icon icon-check-green"></i></span>
												<span class="form-checkbox__text"><span class="locations-filter-modal-content__checkbox-text">After-Hours Service Available</span></span>
											</label>
										</div>
										<div class="modal-buttons-container"><button class="btn modal-button modal-cancel" type="button">Cancel</button><button class="btn modal-button js-modal-apply" type="button">Apply</button></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				`);

				var modalContainer = document.querySelector('.ReactModalPortal');
				var modal = modalContainer.querySelector(".ReactModal__Overlay.ReactModal__Overlay--after-open.modal-overlay");
				var closeModalBtn = modalContainer.querySelector(".close-modal");
				var cancelModalBtn = modalContainer.querySelector(".btn.modal-button.modal-cancel");

				var applyModalBtn = modalContainer.querySelector(".btn.modal-button.js-modal-apply");
				var checkboxes = modalContainer.querySelectorAll(".form-checkbox__input");

				// Apply filters on click of apply button
				applyModalBtn.addEventListener('click', function (event) {
					checkboxes.forEach(function (checkbox) {
						if(isoTest.filtersApplied[checkbox.name] !== checkbox.checked) {
							isoTest.applyFilter(checkbox.id);
						}
					});

					isoTest.triggerUpdate();
				});

				// On click of checkboxes we'll want to add/hide the "Clear all" modal button
				checkboxes.forEach(function (checkbox) {
					checkbox.addEventListener('change', function (e) {
						if (checkbox.checked) {
							checkbox.parentElement.classList.add('checked');
						} else {
							checkbox.parentElement.classList.remove('checked');
						}
					});
				});
				closeModalBtn.addEventListener('click', function (event) {
					modal.remove()
				});
				cancelModalBtn.addEventListener('click', function (event) {
					modal.remove()
				});
			},
			//Add enet lsteners to eveything
			fireTag: function (element, value) {
				var linkName = value ? value : element.innerText;
				linkName = isoTest.test ? isoTest.test + ' : ' + linkName : linkName;
				s.linkTrackVars = 'eVar20';
				s.eVar20 = linkName;
				s.tl(this, 'o', linkName);
			},
			log: function (obj) {
				if (isoTest.debug === true) {
					console.log(obj);
				}
			}
		};

		var helpers = {
			elementLoaded: function (ele, callback) {
				isoTest.log('elementLoaded::  ' + ele + ' - Checking...');
				window.clearTimeout(isoTest.eleTimer);
				if (document.querySelectorAll(ele).length > 0) {
					if (typeof callback === 'function') {
						isoTest.log('elementLoaded::  ' + ele + ' - Found!');
						callback();
					}
				} else {
					isoTest.eleTimer = window.setTimeout(function () { helpers.elementLoaded(ele, callback); }, 100);
				}
			}
		};

		isoTest.init();
	})();
</script>