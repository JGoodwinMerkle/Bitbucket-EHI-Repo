<style>
.iso-mileage-filter .vehicle-filter__filter-list {
	width: 100%;
}
</style>
<script>
(function() {
	'use strict';
	var isoTest = {
		account : 'Enterprise',
		portfolio : 'Enterprise.com',
		test : 'Vehicle Selection Mileage Filter',
		creative : 'Challenger 1',
		selector: '.vehicle-list__item',
		content: '<div class="vehicle-filter__filter iso-mileage-filter">\
								<span class="vehicle-filter__filter-title">MILEAGE</span>\
								<div class="vehicle-filter__list-content">\
									<ul class="vehicle-filter__filter-list">\
										<li>\
											<label class="checkbox__label" tabindex="0" id="checkbox_unlimited_mileage-label">\
												<span class="checkbox__label-checkbox" >\
													<input type="checkbox" name="mileage_type" value="Unlimited Mileage" id="checkbox_unlimited">\
													<i class="icon icon-check-green"></i>\
												</span>\
												<span class="checkbox__text">Unlimited Mileage</span>\
											</label>\
										</li>\
										<li>\
											<label class="checkbox__label" tabindex="0" id="checkbox_limited_mileage-label">\
												<span class="checkbox__label-checkbox" >\
													<input type="checkbox" name="mileage_type" value="Limited Mileage" id="checkbox_limited">\
													<i class="icon icon-check-green"></i>\
												</span>\
												<span class="checkbox__text">Limited Mileage</span>\
											</label>\
										</li>\
									</ul>\
								</div>\
							</div>',
		mileageObject: {},
		init : function() {

			isoTest.debug = ${user.mvtDebug};
			
			if (_satellite && typeof _satellite.setVar === 'function' && typeof _satellite.track === 'function') {
				_satellite.setVar('TargetCampaign', isoTest.test);
				_satellite.setVar('TargetCreative', isoTest.creative);
				//_satellite.track('target_variables');
			}

			isoTest.log('Test Running...');
			isoTest.log(isoTest.account + ' - ' + isoTest.portfolio);
			isoTest.log(isoTest.test + ' - ' + isoTest.creative);

			helpers.elementLoaded(isoTest.selector, function() {
				isoTest.log('Test Ready!');
  				isoTest.chall();
			});
			
		window.addEventListener('hashchange', isoTest.viewChange, false);
		
		},
		viewChange : function(){
			if(/cars/.test(location.hash)){
				helpers.elementLoaded(isoTest.selector, function() {
					isoTest.chall();
				});
			}
		},
		chall : function() {
			document.querySelector('.vehicle-filter__header').insertAdjacentHTML('afterend', isoTest.content);

			isoTest.findMileage();
			isoTest.addEvents();
		},
		findMileage : function() {
			var vehicleItems = document.querySelectorAll('.vehicle-list__item');
			for(var i = 0; i < vehicleItems.length; i++) {
				var dataInfo = vehicleItems[i].getAttribute('data-dtm-tracking').split('|');
				var carClass = dataInfo[1];
				var avail = dataInfo[2];
				if (avail != 'SOLD_OUT' && avail != 'RESTRICTED_AT_RETAIL_RATE') {
					isoTest.checkMileage(carClass, function(mileage){
						console.log(mileage);
						console.log(isoTest.mileageObject);
					});
				} else {
					isoTest.mileageObject[carCode] = 'unavailable';
				}
			}
		},
		checkMileage : function(carCode, callback) {
			var url = enterprise.services.path + '/reservations/carClassDetails?carClassCode=';
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
		    if (this.readyState == 4 && this.status == 200) {
	        var carDetails = JSON.parse(xhttp.responseText);
        	var hasUnlimited = carDetails.car_class_details.mileage_info.unlimited_mileage;
        	console.log(carCode);
       		console.log(carDetails.car_class_details.mileage_info.unlimited_mileage);
       		isoTest.mileageObject[carCode] = hasUnlimited;
       		
       		callback(hasUnlimited);
		    }
			};
			url = url + carCode;
			xhttp.open("POST", url, true);
			xhttp.withCredentials = true;
			xhttp.send();
		},
		checkForFilters : function() {
			var unlimited = document.querySelector('#checkbox_unlimited_mileage-label .checkbox__label-checkbox.checked');
			var limited = document.querySelector('#checkbox_limited_mileage-label .checkbox__label-checkbox.checked');

			var vehicleItems = document.querySelectorAll('.vehicle-list__item');
			for(var i = 0; i < vehicleItems.length; i++) {
				var dataInfo = vehicleItems[i].getAttribute('data-dtm-tracking').split('|');
				var carClass = dataInfo[1];
				var avail = dataInfo[2];
				if (avail != 'SOLD_OUT' && avail != 'RESTRICTED_AT_RETAIL_RATE') {
					
				}
			}

			if (unlimited) {
				if (limited) {

				}
			}
		},
		addEvents : function() {
			var filterElements = document.querySelectorAll('.vehicle-filter__filter.iso-mileage-filter .checkbox__label-checkbox input');
			for(var i = 0; i < filterElements.length; i++) {
				filterElements[i].addEventListener('click', function(event){
					if (event.target.parentNode.classList.contains("checked")) {
						console.log('remove');
						event.target.parentNode.classList.remove('checked');
					} else {
						console.log('add');
						event.target.parentNode.classList.add('checked');
					}
		
				}, false);
			}
		},
		fireTag : function(element, value) {
			var linkName = value ? value : element.innerText;
				linkName = isoTest.test ? isoTest.test + ' : ' + linkName : linkName;
			s.linkTrackVars = 'eVar20';
			s.eVar20 = linkName;
			s.tl(this, 'o', linkName);
		},
		log : function(obj){
			if(isoTest.debug === true){
				console.log(obj);
			}
		}

	}

	var helpers = {
		elementLoaded : function (ele, callback) {
			isoTest.log('elementLoaded::  ' + ele + ' - Checking...');
			window.clearTimeout(isoTest.eleTimer);
			if (document.querySelectorAll(ele).length > 0) {
				if (typeof callback === 'function') {
					isoTest.log('elementLoaded::  ' + ele + ' - Found!');
					callback();
				}
	        } else {
	            isoTest.eleTimer = window.setTimeout(function(){helpers.elementLoaded(ele, callback);}, 100);
	        }
		},
	    supplant : function(str, o) {
			return str.replace(/{([^{}]*)}/g, function(a, b) {
		        var p = b.split(/\./),
		            c = o;
		        for (var i = 0; i < p.length; i++) {
		          if (c[p[i]] == null)
		            return a;
		          c = c[p[i]];
		        }
				return typeof c === 'string' || typeof c === 'number' ? c : a;
			});
		}
	}

	isoTest.init();
})();
</script>
