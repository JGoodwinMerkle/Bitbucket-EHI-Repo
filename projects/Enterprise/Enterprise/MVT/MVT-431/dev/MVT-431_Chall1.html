<style>
	.locations-filter-modal-content__checkbox-text {
    align-items: center;
    display: flex;
    margin-top: 0.125rem;
	}
	.locations-filter-modal-content__checkbox-text .icon {
    margin-left: 0.3125rem;
	}
	.locations-filter-modal-content__checkbox {
    margin-bottom: 0.9375rem;
	}
	.icon-location{
		filter: brightness(0);
	}
	.locations-filter-modal-content__checkbox-text .icon.icon-after-hours{
		background-image: url("data:image/svg+xml;charset=utf8,%3Csvg width='19' height='19' viewBox='0 0 19 19' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M9.29998 18.2969C9.29894 18.2969 9.29791 18.2969 9.29688 18.2969C4.32641 18.2969 0.296875 14.2673 0.296875 9.29688C0.296875 4.32641 4.32641 0.296875 9.29688 0.296875C9.29791 0.296875 9.29894 0.296875 9.29998 0.296875C14.2685 0.298553 18.2969 4.32771 18.2969 9.29688C18.2969 14.266 14.2685 18.2952 9.29998 18.2969ZM9.29998 1.22791V17.3658C13.7543 17.3642 17.3658 13.7518 17.3658 9.29687C17.3658 4.84192 13.7543 1.22959 9.29998 1.22791Z' fill='%23393A3B'/%3E%3Cmask id='mask0_99_153787' style='mask-type:alpha' maskUnits='userSpaceOnUse' x='0' y='0' width='9' height='18'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M9.00012 0.29712C8.99912 0.297119 8.99812 0.297119 8.99712 0.297119C4.19234 0.297119 0.297119 4.19234 0.297119 8.99712C0.297119 13.8019 4.19234 17.6971 8.99712 17.6971C8.99812 17.6971 8.99912 17.6971 9.00012 17.6971V0.29712Z' fill='white'/%3E%3C/mask%3E%3Cg mask='url(%23mask0_99_153787)'%3E%3C/g%3E%3C/svg%3E");
	}
	.locations-filter-modal-content .modal-content__heading {
    display: flex;
    justify-content: space-between;
	}
	.location-search-filter__clear-all:not(.js-clear-all){
		display: none;
	}
</style>
<script>
	(function () {
		'use strict';

		var isoTest = {
			account: 'EHI',
			portfolio: 'Enterprise',
			test: 'MVT-431',
			creative: 'Challenger 1',
			selector: '#location-search-available-filter + span + .form-checkbox__text, .filter-modal-button.locations-filter-trigger.location-search-filter__locations-filter.location-search-filter__filter-input .icon.icon-nav-carrot-down',
      filtersApplied: {
        numApplied: 0,
        openSundays: false,
        afterHoursPickup: false,
        afterHoursReturn: false
      },
			tabbableElements : 'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]',
			init: function () {

				var open_prototype = window.XMLHttpRequest.prototype.open;
        window.XMLHttpRequest.prototype.open = function() {
          this.addEventListener('readystatechange', function(event) {
              var matchPageHash = window.location.hash === '#location';
              var matchRequest = this.responseURL.indexOf('prd.location.enterprise.com/enterprise-sls/search/location/enterprise/web/spatial') > -1;
              var matchParams = this.responseURL.indexOf('&pickupDate') > -1;
              
              if ( this.readyState === 4 && matchRequest && matchParams && matchPageHash ) {

                var response = event.target.responseText;
                Object.defineProperty(this, 'response',     {writable: true});
                Object.defineProperty(this, 'responseText', {writable: true});

                var initialRequest = JSON.parse(response);
                if(initialRequest.result && initialRequest.result.length > 0) {

                  initialRequest.result = isoTest.filterRequest(initialRequest.result);

                  response =  JSON.stringify(initialRequest);
                }

                this.response = this.responseText = response;
              }
          });
          return open_prototype.apply(this, arguments);
        };

				if (_satellite && typeof _satellite.setVar === 'function' && typeof _satellite.track === 'function') {
					_satellite.setVar('TargetCampaign', isoTest.test);
					_satellite.setVar('TargetCreative', isoTest.creative);
				}

				isoTest.log('Test Running...');
				isoTest.log(isoTest.account + ' - ' + isoTest.portfolio);
				isoTest.log(isoTest.test + ' - ' + isoTest.creative);

				helpers.elementLoaded(isoTest.selector, function () {
					isoTest.log('Test Ready!');
					isoTest.chall();

					isoTest.watchFilter();
				});

			},
			getTotalFilters : function(){
				var locationFilter = document.querySelector('.btn[name="locations-filter-trigger"]:not(.service-trigger)');
				var locationText = locationFilter.childNodes[0].nodeValue;
				var totalLocation = 0;
				
				if(locationText !== 'All Locations'){
					var moreThanOneLocation = isoTest.getFilterCount(locationFilter);
					if(moreThanOneLocation){
						totalLocation = moreThanOneLocation;
					}else{
						totalLocation = 1;
					}
				}

				var vehicleClass = document.querySelector('[name="vehicle-filters-trigger"]');
				var vehicleText = vehicleClass.childNodes[0].nodeValue;
				var totalVehicle = (vehicleText === 'All Vehicles') ? 0 : 1;

				var totalOther = document.querySelectorAll('.location-search-filter__container-check-filters-block label:not(.js-sunday) input:checked').length;

				var totalFilters = totalLocation + totalVehicle + totalOther + isoTest.filtersApplied.numApplied;
				
				return totalFilters;
			},
			getFilterCount : function(filterButton){
				var filterText = filterButton.childNodes[0].nodeValue;
				var regEx = /(Filter|Locations) \((\d*)\)/;
				var numMatch = filterText.match(regEx);
				var numText = (!!numMatch && numMatch[2]) ? numMatch[2] : 0;
				var numValue = parseInt(numText);

				return numValue;
			},
			watchFilter : function(){
				// Add a mutation observer that watches for changes to the filter and makes sure the filter count is update
				var filterButton = document.querySelector('.location-header__toggle-buttons [aria-label*="Filter"]');

				var observeEverything = new MutationObserver(function(observedEl) {
					isoTest.updateFilterCount();
				});
				observeEverything.observe(filterButton, {
					attributes: false,
					childList: true,
					characterData: true,
					subtree: true
				});
			},
			updateFilterCount : function(){
				var totalFilters = isoTest.getTotalFilters();

				var filterButton = document.querySelector('.location-header__toggle-buttons [aria-label*="Filter"]');
				var filterNum = isoTest.getFilterCount(filterButton);

				if(totalFilters !== filterNum){
					var filterCount = (totalFilters > 0) ? '(' + totalFilters + ')' : '';

					filterButton.setAttribute('aria-label', 'Filter ' + filterCount);
					filterButton.childNodes[0].nodeValue = 'Filter ' + filterCount;
				}
			},
			updateServicesCount : function(){
				var pickupCount = isoTest.filtersApplied.afterHoursPickup ? 1 : 0;
				var returnCount = isoTest.filtersApplied.afterHoursReturn ? 1 : 0;
				var totalFilters = pickupCount + returnCount;
				var serviceButton = document.querySelector('.service-trigger button');

				var filterCount = (totalFilters > 0) ? 'Services (' + totalFilters + ')' : 'All Services';
				serviceButton.childNodes[0].nodeValue = filterCount;
			},
			updateMainClearAll : function(){
				// Check to see if we still need to show our clear all button
				var clearAllButton = document.querySelector('.js-clear-all');
				if(!clearAllButton) return;
				if(isoTest.filtersApplied.numApplied){
					clearAllButton.classList.remove('hide');
				}else{
					clearAllButton.classList.add('hide');
				}
			},
      triggerUpdate : function(){
				isoTest.updateFilterCount();
				isoTest.updateServicesCount();
				isoTest.updateMainClearAll();

        var getReactComponent = function(node){
          for(var key in node) {
            if(key.startsWith('__reactInternalInstance$') ) {
              return node[key];
            }
          }
          return null;
        }
        
        getReactComponent(document.querySelector('.map-wrapper')).return.memoizedProps.onSearchThisArea();
      },
      clearFilters : function(triggerUpdate) {
        isoTest.filtersApplied = {
          numApplied: 0,
          openSundays: false,
          afterHoursPickup: false,
          afterHoursReturn: false
        };

				if(triggerUpdate){
					// Reset our checkbox if it was selected
					var openSundays = document.querySelector('.js-sunday input:checked');
					if(openSundays){
						openSundays.checked = false;
					}
					
					isoTest.triggerUpdate();
				}
      },
      applyFilter : function(filter) {
        isoTest.filtersApplied[filter] = !isoTest.filtersApplied[filter];

        // If we have any filters applied, then we need to show the adjusted results
        isoTest.filtersApplied.numApplied = 0;
        for(var key in isoTest.filtersApplied) {
          if(!!isoTest.filtersApplied[key]){
            isoTest.filtersApplied.numApplied++;
          }
        }
        isoTest.triggerUpdate();
      },
      getFilterMatches : function(results){
        var resultsObj = {
          openSundays: [],
          afterHoursPickup: [],
          afterHoursReturn: []
        }

        results.forEach(function(result){
          if(result.additional_data.open_sundays){
            resultsObj.openSundays.push(result)
          }
          if(result.after_hours_pickup){
            resultsObj.afterHoursPickup.push(result)
          }
          if(result.after_hours_return){
            resultsObj.afterHoursReturn.push(result)
          }
        });

        return resultsObj;
      },
      filterRequest : function(results){
        if(isoTest.filtersApplied.numApplied > 0) {
          var resultsObj = isoTest.getFilterMatches(results);

          var filteredItems = false;
          for(var key in isoTest.filtersApplied) {
            if(isoTest.filtersApplied[key]){
              if(!!filteredItems){
                filteredItems = filteredItems.filter(element => resultsObj[key].includes(element));
              }else{
                filteredItems = resultsObj[key];
              }
            }
          }

          return filteredItems;
        }else{
          return results;
        }
      },
			observeEl : function(selector, callback) {
				var processed = new Map();

				var processElement = function processElement(el) {
					if (processed && !processed.has(el)) {
						processed.set(el, true);
						callback(el);
					}
				};

				var lookForSelector = function lookForSelector() {
					var el = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : document;

					if (el.matches && el.matches(selector)) {
						if (processElement(el)) return true;
					}

					if (el.querySelectorAll) {
						var elements = el.querySelectorAll(selector);

						if (elements.length) {
							for (var i = 0; i < elements.length; i++) {
								var _el = elements[i];
								if (processElement(_el)) return true;
							}
						}
					}
				};
				lookForSelector();

				var obs = new MutationObserver(function (mutationsList) {
					mutationsList.forEach(function (record) {
						if (record && record.addedNodes && record.addedNodes.length) {
							for (var i = 0; i < record.addedNodes.length; i++) {
								var el = record.addedNodes[i].parentElement;
								if (el && lookForSelector(el)) return true;
							}
						}
					});
				});
				obs.observe(document, {
					attributes: false,
					childList: true,
					subtree: true
				});
			},
			chall: function () {
				isoTest.observeEl('.location-header__toggle-buttons [aria-label*="Filter"]', function(filterButton){
					isoTest.clearFilters(false);
					isoTest.creation();
					isoTest.updateMainClearAll();
				});
			},
			clearAllClick: function(){
				var existingClearAll = document.querySelector('.location-search-filter__clear-all:not(.js-clear-all)');
				if(existingClearAll){
					existingClearAll.click();
				}

				isoTest.clearFilters(true);
			},
			//Creation of our items
			creation: function () {
				var codeRan = document.querySelector(".iso");
				if (!codeRan) {
					//We first find our elemnts
					var locationTypeContainer = document.querySelector(".location-search-filter__container-modal-filters-block");
					var locationCheckboxContainer = document.querySelector(".location-search-filter__container-check-filters-block");
					var locationType = document.querySelector(".filter-modal-button.locations-filter-trigger.location-search-filter__locations-filter.location-search-filter__filter-input");
					var locationTypeCarrot = locationType.querySelector(".icon.icon-nav-carrot-down");
					var locationCheckbox = document.querySelector(".form-checkbox.location-search-filter__container-filter");
					//Everything is cloned below
					var modalBtn = locationType.cloneNode(true);
					var checkbox = locationCheckbox.cloneNode(true);
					var modalBtnLabelTxt = modalBtn.querySelector(".filter-modal-button__label-text");
					var modalBtnTxt = modalBtn.querySelector(".btn.filter-modal-button__button.btn-input");
					var checkboxTxt = checkbox.querySelector(".form-checkbox__text");
					var carrot = locationTypeCarrot.cloneNode(true);
					//Cloned elemnets are adjusted below (copy ect)
					modalBtnLabelTxt.innerText = 'Services';
					modalBtnTxt.innerText = 'All Services';
					checkboxTxt.innerText = 'Open Sundays';
					modalBtn.classList.add("iso");
					modalBtn.classList.add('service-trigger');
					checkbox.classList.add("iso");
					checkbox.id = 'sunday-search-available-filter';
          checkbox.classList.add('js-sunday');
					locationType.insertAdjacentElement("afterend", modalBtn);
					modalBtn.insertAdjacentHTML('afterend', `<button class="cta cta--text cta--text-a11y cta--large location-search-filter__clear-all js-clear-all" aria-label="Clear All">Clear All</button>`);
					locationCheckboxContainer.insertAdjacentElement("beforeend", checkbox);
					modalBtn.querySelector(".btn.filter-modal-button__button.btn-input").insertAdjacentElement("beforeend", carrot);


          var openSundays = document.querySelector('.js-sunday input');
          openSundays.addEventListener('change', function(e) {
            isoTest.applyFilter('openSundays');
          });

					modalBtnTxt.addEventListener('click', function (event) {
						isoTest.modalFunctionality()
					});

					var clearAll = document.querySelector('.js-clear-all');
					clearAll.addEventListener('click', function(){
						isoTest.clearAllClick();
					});
				}
			},
			keepFocus : function(context) {
    		context.querySelector('.close-modal').focus();

	    	var allTabbableElements = context.querySelectorAll(isoTest.tabbableElements),
	        	firstTabbableElement = allTabbableElements[0],
	          	lastTabbableElement = allTabbableElements[allTabbableElements.length - 1];

	      	var keyListener = function(e) {
	    		var keyCode = e.which || e.keyCode;

	    		e.preventDefault = e.preventDefault || function () {
	    			e.returnValue = false;
	    		};

	    		if (keyCode === 9) {
	          		if (e.target === lastTabbableElement && !e.shiftKey) {
	    				e.preventDefault();
	    				firstTabbableElement.focus();
	          		} else if (e.target === firstTabbableElement && e.shiftKey) {
	    				e.preventDefault();
	    				lastTabbableElement.focus();
	    			}
	    		}
	    	};
	    	context.addEventListener('keydown', keyListener, false);
	    },
			modalFunctionality: function () {

				var afterHoursPickupChecked = isoTest.filtersApplied.afterHoursPickup ? 'checked' : '';
				var afterHoursReturnChecked = isoTest.filtersApplied.afterHoursReturn ? 'checked' : '';

				document.querySelector('.ReactModalPortal').insertAdjacentHTML("beforeend", `
					<div class="ReactModal__Overlay ReactModal__Overlay--after-open modal-overlay">
						<div class="ReactModal__Content ReactModal__Content--after-open default-modal" tabindex="-1" role="dialog" aria-labelledby="modal-heading" aria-modal="true" aria-describedby="modal-content">
							<div class="modal-inner">
								<div class="modal-header">
									<button class="cta cta--text cta--large cta--noMargin cta--text-inverted modal-header__close-icon close-modal" aria-label="Close">
										<i role="img" aria-hidden="true" class="cta__icon">
											<svg viewBox="0 0 24 24">
												<use xlink:href="#btn-icn-close"></use>
											</svg>
										</i>
									</button>
								</div>
								<div class="modal-content cf">
									<div class="locations-filter-modal-content">
										<h2 id="modal-heading" class="modal-content__heading">Services</h2>
										<div class="locations-filter-modal-content__filters" id="modal-content">
											<p>Select the service you want to search by.</p>
											<label class="form-checkbox locations-filter-modal-content__checkbox ` + afterHoursReturnChecked + `">
												<input ` + afterHoursReturnChecked + ` type="checkbox" name="afterHoursReturn" id="afterHoursReturn" class="form-checkbox__input is-vishidden" value="" /><span class="form-checkbox__control"><i class="icon icon-check-green"></i></span>
												<span class="form-checkbox__text"><span class="locations-filter-modal-content__checkbox-text">Pick-Up Service Available <i class="icon icon-location"></i></span></span>
											</label>
											<label class="form-checkbox locations-filter-modal-content__checkbox ` + afterHoursPickupChecked + `">
												<input ` + afterHoursPickupChecked + ` type="checkbox" name="afterHoursPickup" id="afterHoursPickup" class="form-checkbox__input is-vishidden" value="" /><span class="form-checkbox__control"><i class="icon icon-check-green"></i></span>
												<span class="form-checkbox__text"><span class="locations-filter-modal-content__checkbox-text">After-Hours Service Available <i class="icon icon-after-hours"></i></span></span>
											</label>
										</div>
										<div class="cta-container cta-container--align-center modal-buttons-container"><button class="cta cta--secondary cta--large cta--noMargin modal-cancel" type="button">Cancel</button><button class="cta cta--primary cta--large cta--noMargin js-modal-apply" type="button">Apply</button></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				`);

				var modalContainer = document.querySelector('.ReactModalPortal');
				var modal = modalContainer.querySelector(".ReactModal__Overlay.ReactModal__Overlay--after-open.modal-overlay");
				var closeModalBtn = modalContainer.querySelector(".close-modal");
				var cancelModalBtn = modalContainer.querySelector(".modal-cancel");
				var modalHeading = modal.querySelector('#modal-heading');

				var applyModalBtn = modalContainer.querySelector(".js-modal-apply");
				var checkboxes = modalContainer.querySelectorAll(".form-checkbox__input");

				isoTest.keepFocus(modal);

				// Apply filters on click of apply button
				applyModalBtn.addEventListener('click', function (event) {
					checkboxes.forEach(function (checkbox) {
						if(isoTest.filtersApplied[checkbox.name] !== checkbox.checked) {
							isoTest.applyFilter(checkbox.id);
						}
					});

					isoTest.triggerUpdate();
					modal.remove()
				});

				var numOfCheckedInputs = function(){
					return modal.querySelectorAll('.checked input').length;
				};

				var updateClearAll = function(){
					if(numOfCheckedInputs() > 0){
						if(!modalHeading.querySelector('.cta')){
							modalHeading.insertAdjacentHTML('beforeend', `
								<button class="cta clear-all cta--text cta--large cta--noMargin" aria-label="Clear All">Clear All</button>
							`);
							var clearAll = modalHeading.querySelector('.cta');
							clearAll.addEventListener('click', function(){
								checkboxes.forEach(function (checkbox) {
									checkbox.parentElement.classList.remove('checked');
									checkbox.checked = false;
								});

								clearAll.remove();
							});
						}
					}else{
						var clearAllButton = modalHeading.querySelector('.cta');
						if(clearAllButton){
							clearAllButton.remove();
						}
					}
				}

				// On click of checkboxes we'll want to add/hide the "Clear all" modal button
				checkboxes.forEach(function (checkbox) {
					checkbox.addEventListener('change', function (e) {
						if (checkbox.checked) {
							checkbox.parentElement.classList.add('checked');
						} else {
							checkbox.parentElement.classList.remove('checked');
						}

						updateClearAll();
					});

					checkbox.addEventListener('keyup', function(event) {
						if (event.key === 'Enter') {
							checkbox.checked = !checkbox.checked;
						}
					});
				});
				updateClearAll();
				closeModalBtn.addEventListener('click', function (event) {
					modal.remove()
				});
				cancelModalBtn.addEventListener('click', function (event) {
					modal.remove()
				});
			},
			//Add enet lsteners to eveything
			fireTag: function (element, value) {
				var linkName = value ? value : element.innerText;
				linkName = isoTest.test ? isoTest.test + ' : ' + linkName : linkName;
				s.linkTrackVars = 'eVar20';
				s.eVar20 = linkName;
				s.tl(this, 'o', linkName);
			},
			log: function (obj) {
				if (isoTest.debug === true) {
					console.log(obj);
				}
			}
		};

		var helpers = {
			elementLoaded: function (ele, callback) {
				isoTest.log('elementLoaded::  ' + ele + ' - Checking...');
				window.clearTimeout(isoTest.eleTimer);
				if (document.querySelectorAll(ele).length > 1) {
					if (typeof callback === 'function') {
						isoTest.log('elementLoaded::  ' + ele + ' - Found!');
						callback();
					}
				} else {
					isoTest.eleTimer = window.setTimeout(function () { helpers.elementLoaded(ele, callback); }, 100);
				}
			}
		};

		isoTest.init();
	})();
</script>